<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zero Rotation — Character Sheet</title>
<style>

  :root { --ink:#333; --mid:#d7d7d7; --light:#f3f3f3; --accent:#000; --red:#c81d1d; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:Helvetica, Arial, sans-serif; color:var(--ink); background:#fff; }
  .page { width:1100px; margin:24px auto; padding:0 24px 24px; }

  /* Two-column layout */
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
  .left, .right { display:flex; flex-direction:column; gap:24px; }

  .card { border:1px solid var(--mid); border-radius:6px; padding:12px; background:#fff; }
  .section-title { background:#efefef; padding:6px 8px; margin:-12px -12px 12px; border-bottom:1px solid var(--mid); font-size:14px; letter-spacing:.5px; }
  .line { border-bottom:1px solid var(--mid); min-height:20px; }
  .block-wide { border:1px solid var(--mid); min-height:120px; border-radius:4px; }

  /* Stats */
  .stat-row { display:grid; grid-template-columns: 260px 60px 1fr; align-items:center; gap:12px; padding:8px 0; border-top:1px dashed #e6e6e6; }
  .stat-row:first-child { border-top:none; }
  .stat-name { font-weight:700; font-size:12px; letter-spacing:.5px; }
  .stat-desc { font-size:10px; color:#777; }
  .circle { width:50px; height:50px; border:2px solid var(--ink); border-radius:50%; display:flex; align-items:center; justify-content:center; }
  .circle1 { width:30px; height:30px; border:2px solid var(--ink); border-radius:50%; display:flex; align-items:center; justify-content:center; }
  .track-label { font-size:9px; color:#777; }
  .ticks { display:grid; grid-template-columns: repeat(20, 1fr); gap:3px; margin-top:4px; }
  .tick input { display:none; }
  .tick span { display:block; height:12px; background:#e0e0e0; border:1px solid #cfcfcf; }
  .tick input:checked + span { background:#6b6b6b; border-color:#4d4d4d; }

  /* Combat & Survival */
  .row-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .hearts { display:flex; gap:4px; align-items:center; }
  .heart input { display:none; }
  .heart span { font-size:20px; color: var(--red); }
  .heart input:not(:checked) + span { color:#000; }

  /* backpack */
  .back-boxes { display:grid; grid-template-columns: repeat(10, 2fr); gap:8px; }
  .back-slot { border:2px solid var(--ink); border-radius:4px; min-height:52px; padding:6px; font-size:18px; background:#fff; }

  /* Inventory v5.2 working style: explicit 2x5 boxes, contenteditable */
  .inv-boxes { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
  .inv-slot { border:2px solid var(--ink); border-radius:4px; min-height:52px; padding:6px; font-size:18px; background:#fff; }
  .inventory .label-row { display:flex; align-items:center; justify-content:space-between; margin-top:8px; }

  .list-box .list-item { display:block; margin:6px 0; font-size:12px; }
  .list-box .list-item input { margin-right:8px; }
  .list-box .hint { font-size:10px; color:#777; margin-bottom:8px; }

  .effects-small .block-wide { min-height:60px; }

  @media print { .page { width:auto; margin:0; } }


/* =====================
   Layout tightening
   ===================== */
.page{
  padding:0.35in !important;
  gap:10px !important;
}
h1{margin:0 0 8px !important; letter-spacing:.2px;}
.section-title{margin:0 0 8px !important;}

/* Reduce whitespace at the top of first cards */
.grid{gap:12px !important;}
.card{padding:10px !important;}

/* ============================
   COMPACT STATS + BIGGER XP
   ============================ */
.stat-row{grid-template-columns: 205px 42px 1fr !important; gap:8px !important; padding:3px 0 !important;}
.circle{width:36px !important; height:36px !important; border-width:2px !important;}
.stat-name{font-size:11px !important;}
.stat-desc{font-size:9.5px !important;}
.track-label{font-size:10px !important;}
.ticks{gap:5px !important; margin-top:3px !important;}
.tick span{height:20px !important; border-radius:2px;}

/* ==============================
   CLICKABLE HEARTS (SVG, iPad)
   ============================== */
.hearts.clickable{display:flex;flex-wrap:wrap;gap:8px;padding:4px 0;}
.hearts.clickable.small{gap:6px;}

.heart-btn{
  -webkit-appearance:none;appearance:none;
  width:46px;height:46px;
  border-radius:12px;
  border:1px solid rgba(10,40,70,.24);
  background:transparent;
  display:inline-flex;align-items:center;justify-content:center;
  padding:0;margin:0;
  cursor:pointer;
  user-select:none;
  touch-action:manipulation;
}
.hearts.clickable.small .heart-btn{width:32px;height:32px;border-radius:10px;}
.heart-btn:active{transform:scale(.98);}
.heart-btn svg{width:28px;height:28px;display:block;}
.hearts.clickable.small .heart-btn svg{width:18px;height:18px;}
.heart-btn .fill{fill:none;}
.heart-btn .stroke{stroke: rgba(10,40,70,.55);}
.heart-total{font-size:12px;opacity:.85;margin-top:2px;}

/* ===============================
   STRONGER COLLAPSE (Abilities)
   =============================== */
.list-box{position:relative;}
.list-box .hint{margin:0 0 6px;}
.list-box .list-item{display:flex;gap:8px;align-items:center;margin:1px 0;}
.list-box.collapsed{padding:10px !important;}
.list-box.collapsed .hint{display:none !important;}
.list-box.collapsed .list-item{display:none !important;}

.selected-summary{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin:4px 0 0;
}
.selected-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(10,40,70,.18);
  background:rgba(255,255,255,.55);
}

.mini-actions{display:flex;gap:8px;align-items:center;margin-top:8px;}
.mini-btn{
  -webkit-appearance:none;appearance:none;
  border:1px solid rgba(10,40,70,.20);
  background:rgba(255,255,255,.55);
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}
.mini-btn:active{transform:scale(.98);}
.status-pill{
  display:inline-flex;
  align-items:center;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(10,40,70,.18);
  background:rgba(255,255,255,.5);
}

/* =====================
   Followers on Page 1
   ===================== */
.followers-section{margin-top:10px;}
.followers-title{margin:4px 0 8px; border-bottom:2px solid rgba(10,40,70,.25); padding-bottom:6px;}
.followers-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:10px;
}
.follower-card{gap:8px !important; padding:10px !important;}
.follower-card textarea{min-height:56px !important;}
.follower-card .slot input{height:54px !important;}
.follower-card .slots{gap:8px !important;}

@media (max-width: 800px){
  .followers-grid{grid-template-columns:1fr;}
}

/* =======================
   ICY WINTER / COLD THEME
   ======================= */
:root{
  --ice-sky-1:#eaf6ff;
  --ice-sky-2:#cfeaff;
  --ice-sky-3:#a7d8ff;
  --ice-card:rgba(255,255,255,.62);
  --ice-card-strong:rgba(255,255,255,.78);
  --ice-border:rgba(255,255,255,.45);
  --ice-border-dark:rgba(10,40,70,.25);
  --ice-text:#082133;
  --ice-muted:rgba(8,33,51,.65);
  --ice-accent:#42c6ff;
  --ice-shadow:0 18px 40px rgba(4, 18, 34, .18);
}
html,body{height:100%;}
body{
  background:
    radial-gradient(1200px 600px at 10% 0%, rgba(255,255,255,.75), rgba(255,255,255,0) 60%),
    radial-gradient(900px 500px at 100% 10%, rgba(124,240,255,.35), rgba(124,240,255,0) 60%),
    linear-gradient(180deg, var(--ice-sky-1), var(--ice-sky-2) 45%, var(--ice-sky-3)) !important;
  color:var(--ice-text) !important;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:.40;
  background-image:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,.75) 0 1px, transparent 1.2px),
    radial-gradient(circle at 30% 70%, rgba(255,255,255,.55) 0 1px, transparent 1.2px),
    radial-gradient(circle at 60% 40%, rgba(255,255,255,.65) 0 1px, transparent 1.2px),
    radial-gradient(circle at 80% 85%, rgba(255,255,255,.6) 0 1px, transparent 1.2px);
  background-size: 180px 180px, 220px 220px, 260px 260px, 300px 300px;
  mix-blend-mode: overlay;
}
body::after{
  content:"";
  position:fixed;
  inset:-40px 0 0 0;
  pointer-events:none;
  opacity:.20;
  background-image:
    radial-gradient(circle, rgba(255,255,255,.9) 0 1px, transparent 1.4px),
    radial-gradient(circle, rgba(255,255,255,.8) 0 1px, transparent 1.4px),
    radial-gradient(circle, rgba(255,255,255,.7) 0 1px, transparent 1.4px);
  background-size: 140px 140px, 200px 200px, 260px 260px;
  animation: snowDrift 18s linear infinite;
}
@keyframes snowDrift{from{transform:translateY(-40px);}to{transform:translateY(220px);}}

.page{
  background: var(--ice-card) !important;
  border: 1px solid var(--ice-border);
  border-radius: 16px;
  box-shadow: var(--ice-shadow);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  outline:none !important;
}
.card, .fcard{
  background: var(--ice-card-strong) !important;
  border-color: var(--ice-border-dark) !important;
  box-shadow: 0 10px 24px rgba(4,18,34,.10);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
label{color:var(--ice-muted) !important;}

/* Hearts become icy cyan when filled */
.heart-btn.filled{border-color: rgba(66,198,255,.65) !important; box-shadow: 0 0 0 3px rgba(66,198,255,.10), 0 10px 18px rgba(4,18,34,.12);} 
.heart-btn.filled .fill{fill: var(--ice-accent) !important;}
.heart-btn.filled .stroke{stroke: var(--ice-accent) !important;}

@media print{
  body{background:#fff !important;}
  body::before, body::after{display:none !important;}
  .page, .card, .fcard{backdrop-filter:none !important; -webkit-backdrop-filter:none !important; box-shadow:none !important; background:#fff !important;}
}

@media (prefers-color-scheme: dark){
  :root{
    --ice-card: rgba(9,22,36,.62);
    --ice-card-strong: rgba(9,22,36,.74);
    --ice-border: rgba(255,255,255,.12);
    --ice-border-dark: rgba(255,255,255,.14);
    --ice-text: #eaf6ff;
    --ice-muted: rgba(234,246,255,.75);
  }
  body{
    background:
      radial-gradient(900px 500px at 20% 0%, rgba(124,240,255,.18), rgba(124,240,255,0) 60%),
      radial-gradient(1000px 700px at 90% 10%, rgba(66,198,255,.12), rgba(66,198,255,0) 60%),
      linear-gradient(180deg, #061626, #071a2b 50%, #05121f) !important;
  }
  .selected-chip,.mini-btn,.status-pill{background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.14); color:var(--ice-text);} 
  .heart-btn{border-color: rgba(255,255,255,.22) !important;}
  .heart-btn .stroke{stroke: rgba(234,246,255,.78) !important;}
}


/* === Shared autosave (server) === */
#zr-sharebar{
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 9999;
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 8px 10px;
  border: 1px solid #cfcfcf;
  border-radius: 12px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 10px 30px rgba(0,0,0,.12);
  font-size: 12px;
}
#zr-sharebar button{
  border: 1px solid #cfcfcf;
  background: #fff;
  padding: 6px 8px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 12px;
}
#zr-sharebar button:hover{ border-color:#999; }
#zr-sharebar .zr-status{ color:#444; min-width: 120px; text-align:center; }
#zr-sharebar .zr-dot{ width:8px; height:8px; border-radius:999px; background:#bbb; display:inline-block; margin-right:6px; }
#zr-sharebar[data-state="ok"] .zr-dot{ background:#17a34a; }
#zr-sharebar[data-state="busy"] .zr-dot{ background:#f59e0b; }
#zr-sharebar[data-state="err"] .zr-dot{ background:#dc2626; }
@media print{ #zr-sharebar{ display:none !important; } }

</style>
</head>
<body>

<div class="page">
  <main class="grid">
    <!-- LEFT COLUMN -->
    <section class="left">
      <div class="card">
        <h3 class="section-title">SESSION DETAILS</h3>
        <label>NAME</label><div class="line" contenteditable></div>
        <label>DATE</label><div class="line" contenteditable></div>
        <label>SESSION OBJECTIVE</label><div class="line" contenteditable></div>
        <label>PERSONAL GOAL</label><div class="block-wide" contenteditable></div>
        <label>DESCRIPTION</label><div class="block-wide" contenteditable></div>
      </div>

      <div class="card">
        <h3 class="section-title">STATS</h3>
            <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">HEALTH</div>
        <div class="stat-desc">Protect, resist, endure</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">STRENGTH</div>
        <div class="stat-desc">Smash, lift, force</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">AGILITY</div>
        <div class="stat-desc">Dodge, sneak, leap</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">CHARISMA</div>
        <div class="stat-desc">Persuade, inspire, terrify</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">LUCK</div>
        <div class="stat-desc">Chance, fortune, turns</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">INTELLIGENCE</div>
        <div class="stat-desc">Know, plan, recall</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">INDUSTRIAL</div>
        <div class="stat-desc">Craft, repair, build</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">RANGED WEAPON HANDLING</div>
        <div class="stat-desc">Aim, shoot, reload</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">HAND-TO-HAND COMBAT</div>
        <div class="stat-desc">Strike, grapple, defend</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
    </div>
        <div class="stat-row">
      <div class="stat-info">
        <div class="stat-name">PERCEPTION</div>
        <div class="stat-desc">Notice, track, search</div>
      </div>
      <div class="circle" title="BASE" contenteditable></div>
      <div class="track" aria-label="XP track">
        <div class="track-label">XP</div>
        <div class="ticks"><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label><label class="tick"><input type="checkbox"><span></span></label></div>
      </div>
  </div>
      </div>
       <div class="card inventory">
        <h3 class="section-title">INVENTORY</h3>
         <div class="inv-boxes">
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
          <div class="inv-slot" contenteditable></div>
        </div>
        <div class="label-row">
          <span>INVENTORY SLOTS (Default:5)</span>
          <div class="circle1" contenteditable title="BASE"></div>

        </div>
        <div class="label-row">
          <span>WEIGHT CARRIED (Default:60LBS)</span>
          <div class="circle1" contenteditable title="BASE"></div>

      </div>
        <label>CURRENTLY EQUIPPED ITEMS</label>
        <div class="block-wide" contenteditable></div>
      </div>
   <div class="card inventory">
     <h3 class="section-title">BACKPACK</h3>
       <div class="inv-boxes">
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
      <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       <div class="inv-slot" contenteditable></div>
       </div>
          <span>BACKPACK TYPE</span>
          <div class="inv-slot" contenteditable></div>    
    </section>

    <!-- RIGHT COLUMN -->
    <section class="right">
      <div class="card list-box" id="sa-list">
        <h3 class="section-title">SPECIAL ABILITIES LIST (Choose two)</h3>
        <div class="hint">Tap/click to check up to two abilities.</div>
        <label class="list-item"><input type="checkbox"> <span>Iron Heart (Health)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Survivor’s Endurance (Health)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Power Strike (Strength)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Heavy Lifter (Strength)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Quick Reflexes (Agility)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Parkour Expert (Agility)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Silver Tongue (Charisma)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Intimidator (Charisma)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Fortune’s Favor (Luck)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Lucky Scavenger (Luck)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Tech Savant (Intelligence)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Tactical Mind (Intelligence)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Master Builder (Industrial)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Resourceful (Industrial)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Sharpshooter (Ranged)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Gunslinger (Ranged)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Martial Artist (Hand-to-Hand)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Throwing Expert (Hand-to-Hand)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Eagle Eye (Perception)</span></label>
        <label class="list-item"><input type="checkbox"> <span>Sixth Sense (Perception)</span></label>
      </div>

      <div class="card list-box" id="neg-list">
        <h3 class="section-title">NEGATIVE TRAITS LIST (role for one)</h3>
        <div class="hint">Tap/click to pick one trait.</div>
        <label class="list-item"><input type="radio" name="neg"> <span>Frail (Health)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Weak Grip (Strength)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Clumsy (Agility)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Awkward (Charisma)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Unlucky (Luck)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Scatterbrained (Intelligence)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Inept Builder (Industrial)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Poor Aim (Ranged Weapon Handling)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Soft Punch (Hand-to-Hand Combat)</span></label>
        <label class="list-item"><input type="radio" name="neg"> <span>Oblivious (Perception)</span></label>
      </div>

      <div class="card">
        <h3 class="section-title">COMBAT & SURVIVAL</h3>
        <div class="row-2">
          <div>
            <label>EQUIPPED WEAPON</label>
            <div class="inv-slot" contenteditable></div>
            <div class="inv-slot" contenteditable></div>
          </div>
          <div>
            <label>EQUIPPED CLOTHING</label>
            <div class="inv-slot" contenteditable></div>
            <div class="inv-slot" contenteditable></div>
            <div class="inv-slot" contenteditable></div>
            <div class="inv-slot" contenteditable></div>
            <div class="inv-slot" contenteditable></div>
          </div>
        </div>
        <div class="row-2" style="margin-top:12px">
          <div>
            <label>CURRENT BODY TEMPERATURE (°C)</label>
            <div class="line" contenteditable>37</div>
          </div>
          <div>
            <label>ENVIRONMENTAL TEMPERATURE (°C)</label>
            <div class="line" contenteditable>-10</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>TOTAL HEARTS: <span id="heart-count"> 10 </span></label>
          <div class="hearts clickable" id="p1-hearts" data-max="20" data-initial="10"></div>
<div class="heart-total">Total clicked: <strong><span id="p1-total">10</span></strong></div>
        </div>
      </div>
      <div class="card effects-small">
        <h3 class="section-title">EFFECTS</h3>
        <label>NEGATIVE EFFECTS</label>
        <div class="block-wide" contenteditable></div>
        <label>POSITIVE EFFECTS</label>
        <div class="block-wide" contenteditable></div>
     </div>

    </section>
  </main>
<section class="followers-section">  <h2 class="followers-title">Followers</h2>  <div class="followers-grid">
<section class="fcard follower-card">
      <div class="fhead"><div class="tag" style="background:#0a84ff;color:#fff;font-weight:700;font-size:12px;padding:4px 8px;border-radius:6px;text-align:center;">Follower #1</div><input type="text" placeholder="Name"></div>
      <div class="f-hearts-wrap"><div class="f-hearts-head">TOTAL HEARTS: <span class="heart-count" id="f1-count">0</span></div><div class="hearts clickable small" id="f1-hearts" data-max="5" data-initial="0"></div>
      <div><label>Equipment / Loadout</label><textarea placeholder="Weapons, armor, tools, consumables"></textarea></div>
      <div class="inv">
        <label>Inventory Slots</label>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="Slot 1: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 2: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 3: item / notes"></div>
        </div>
      </div>
    </section>
<section class="fcard follower-card">
      <div class="fhead"><div class="tag" style="background:#0a84ff;color:#fff;font-weight:700;font-size:12px;padding:4px 8px;border-radius:6px;text-align:center;">Follower #2</div><input type="text" placeholder="Name"></div>
      <div class="f-hearts-wrap"><div class="f-hearts-head">TOTAL HEARTS: <span class="heart-count" id="f1-count">0</span></div><div class="hearts clickable small" id="f2-hearts" data-max="5" data-initial="0"></div>
      <div><label>Equipment / Loadout</label><textarea placeholder="Weapons, armor, tools, consumables"></textarea></div>
      <div class="inv">
        <label>Inventory Slots</label>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="Slot 1: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 2: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 3: item / notes"></div>
        </div>
      </div>
    </section>
<section class="fcard follower-card">
      <div class="fhead"><div class="tag" style="background:#0a84ff;color:#fff;font-weight:700;font-size:12px;padding:4px 8px;border-radius:6px;text-align:center;">Follower #3</div><input type="text" placeholder="Name"></div>
      <div class="f-hearts-wrap"><div class="f-hearts-head">TOTAL HEARTS: <span class="heart-count" id="f3-count">0</span></div><div class="hearts clickable small" id="f3-hearts" data-max="5" data-initial="0"></div>
      <div><label>Equipment / Loadout</label><textarea placeholder="Weapons, armor, tools, consumables"></textarea></div>
      <div class="inv">
        <label>Inventory Slots</label>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="Slot 1: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 2: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 3: item / notes"></div>
        </div>
      </div>
    </section>
<section class="fcard follower-card">
      <div class="fhead"><div class="tag" style="background:#0a84ff;color:#fff;font-weight:700;font-size:12px;padding:4px 8px;border-radius:6px;text-align:center;">Follower #4</div><input type="text" placeholder="Name"></div>
      <div class="f-hearts-wrap"><div class="f-hearts-head">TOTAL HEARTS: <span class="heart-count" id="f4-count">0</span></div><div class="hearts clickable small" id="f4-hearts" data-max="5" data-initial="0"></div>
      <div><label>Equipment / Loadout</label></div>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="equipment 1"></div>
          <div class="slot"><input type="text" placeholder="Equipment 2"></div>
          <div class="slot"><input type="text" placeholder="Equipment 3"></div>
      <div class="inv">
        <label>Inventory Slots</label>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="Slot 1: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 2: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 3: item / notes"></div>
        </div>
      </div>
    </section>
<section class="fcard follower-card">
      <div class="fhead"><div class="tag" style="background:#0a84ff;color:#fff;font-weight:700;font-size:12px;padding:4px 8px;border-radius:6px;text-align:center;">Follower #5</div><input type="text" placeholder="Name"></div>
      <div class="f-hearts-wrap"><div class="f-hearts-head">TOTAL HEARTS: <span class="heart-count" id="f5-count">0</span></div><div class="hearts clickable small" id="f5-hearts" data-max="5" data-initial="0"></div>
      <div><label>Equipment / Loadout</label><textarea placeholder="Weapons, armor, tools, consumables"></textarea></div>
      <div class="inv">
        <label>Inventory Slots</label>
        <div class="slots">
          <div class="slot"><input type="text" placeholder="Slot 1: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 2: item / notes"></div>
          <div class="slot"><input type="text" placeholder="Slot 3: item / notes"></div>
        </div>
      </div>
    </section>  </div></section>
</div>


<template id="heartTpl">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path class="fill" d="M12 21s-7.2-4.4-9.6-8.6C.5 8.6 2.5 5.5 6 5.5c1.9 0 3.4 1 4 2 .6-1 2.1-2 4-2 3.5 0 5.5 3.1 3.6 6.9C19.2 16.6 12 21 12 21z"/>
    <path class="stroke" d="M12 21s-7.2-4.4-9.6-8.6C.5 8.6 2.5 5.5 6 5.5c1.9 0 3.4 1 4 2 .6-1 2.1-2 4-2 3.5 0 5.5 3.1 3.6 6.9C19.2 16.6 12 21 12 21z"
          fill="none" stroke-width="1.8" stroke-linejoin="round"/>
  </svg>
</template>

<script>
(function(){
  const tpl = document.getElementById('heartTpl');

  // ===== Hearts =====
  function setupHearts(containerId, countId, totalId){
    const container = document.getElementById(containerId);
    if(!container) return;

    const max = parseInt(container.dataset.max || '0', 10);
    const initial = parseInt(container.dataset.initial || '0', 10);

    const countEl = document.getElementById(countId);
    const totalEl = document.getElementById(totalId);

    container.innerHTML = '';
    const hearts = [];

    for(let i=0;i<max;i++){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'heart-btn';
      btn.dataset.filled = (i < initial) ? '1' : '0';
      btn.classList.toggle('filled', btn.dataset.filled === '1');
      btn.setAttribute('aria-label', `Heart ${i+1}`);
      btn.appendChild(tpl.content.firstElementChild.cloneNode(true));
      btn.addEventListener('click', () => {
        btn.dataset.filled = (btn.dataset.filled === '1') ? '0' : '1';
        btn.classList.toggle('filled', btn.dataset.filled === '1');
        update();
      });
      container.appendChild(btn);
      hearts.push(btn);
    }

    function update(){
      const filled = hearts.filter(h => h.dataset.filled === '1').length;
      if(countEl) countEl.textContent = filled;
      if(totalEl) totalEl.textContent = filled;
    }

    update();
  }

  // Main hearts
  setupHearts('p1-hearts', 'heart-count', 'p1-total');

  // Followers hearts
  for(let i=1;i<=5;i++){
    setupHearts(`f${i}-hearts`, `f${i}-count`, `f${i}-total`);
  }

  // ===== Collapse Lists into chips =====
  function buildSummary(listEl, texts){
    let summary = listEl.querySelector('.selected-summary');
    if(!summary){
      summary = document.createElement('div');
      summary.className = 'selected-summary';
      // insert after title
      const title = listEl.querySelector('h3');
      title.insertAdjacentElement('afterend', summary);
    }
    summary.innerHTML = '';
    texts.forEach(t => {
      const chip = document.createElement('span');
      chip.className = 'selected-chip';
      chip.textContent = t;
      summary.appendChild(chip);
    });
    return summary;
  }

  function ensureActions(listEl){
    let actions = listEl.querySelector('.mini-actions');
    if(actions) return actions;
    actions = document.createElement('div');
    actions.className = 'mini-actions';

    const pill = document.createElement('span');
    pill.className = 'status-pill';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'mini-btn';
    btn.textContent = 'Change';

    actions.appendChild(pill);
    actions.appendChild(btn);
    listEl.appendChild(actions);
    return actions;
  }

  // Special Abilities (max 2)
  const saList = document.getElementById('sa-list');
  if(saList){
    const inputs = Array.from(saList.querySelectorAll('input[type="checkbox"]'));
    const actions = ensureActions(saList);
    const pill = actions.querySelector('.status-pill');
    const changeBtn = actions.querySelector('.mini-btn');

    function selectedInputs(){
      return inputs.filter(i => i.checked);
    }

    function update(){
      const sel = selectedInputs();
      pill.textContent = `${sel.length}/2 selected`;

      if(sel.length === 2){
        const texts = sel.map(i => (i.closest('label')?.querySelector('span')?.textContent || '').trim()).filter(Boolean);
        buildSummary(saList, texts);
        saList.classList.add('collapsed');
      } else {
        saList.classList.remove('collapsed');
        const summary = saList.querySelector('.selected-summary');
        if(summary) summary.remove();
      }
    }

    inputs.forEach(inp => {
      inp.addEventListener('change', (e) => {
        const sel = selectedInputs();
        if(sel.length > 2){
          e.target.checked = false;
        }
        update();
      });
    });

    changeBtn.addEventListener('click', () => {
      saList.classList.remove('collapsed');
      const summary = saList.querySelector('.selected-summary');
      if(summary) summary.remove();
    });

    update();
  }

  // Negative Traits (1 radio)
  const negList = document.getElementById('neg-list');
  if(negList){
    const radios = Array.from(negList.querySelectorAll('input[type="radio"]'));
    const actions = ensureActions(negList);
    const pill = actions.querySelector('.status-pill');
    const changeBtn = actions.querySelector('.mini-btn');

    function chosen(){
      return radios.find(r => r.checked);
    }

    function update(){
      const c = chosen();
      pill.textContent = c ? '1/1 selected' : '0/1 selected';

      if(c){
        const t = (c.closest('label')?.querySelector('span')?.textContent || '').trim();
        buildSummary(negList, t ? [t] : []);
        negList.classList.add('collapsed');
      } else {
        negList.classList.remove('collapsed');
        const summary = negList.querySelector('.selected-summary');
        if(summary) summary.remove();
      }
    }

    radios.forEach(r => r.addEventListener('change', update));

    changeBtn.addEventListener('click', () => {
      radios.forEach(r => r.checked = false);
      negList.classList.remove('collapsed');
      const summary = negList.querySelector('.selected-summary');
      if(summary) summary.remove();
      update();
    });

    update();
  }
})();
</script>


<script>
/* === Shared persistence (GitHub Pages + Cloudflare Worker) ===
   Anyone with the link can view/edit. Uses ?sheet=<id> in URL.
   Backend: https://black-band-396b.tbowyer101.workers.dev
*/
(() => {
  const API_BASE = 'https://black-band-396b.tbowyer101.workers.dev';

  // Create a small floating share bar (no HTML changes needed)
  const bar = document.createElement('div');
  bar.id = 'zr-sharebar';
  bar.setAttribute('data-state','busy');
  bar.innerHTML = `
    <span class="zr-dot" aria-hidden="true"></span>
    <span class="zr-status" id="zrStatus">Loading…</span>
    <button type="button" id="zrCopy">Copy link</button>
    <button type="button" id="zrSave">Save</button>
  `;
  document.addEventListener('DOMContentLoaded', () => document.body.appendChild(bar));

  const statusEl = () => document.getElementById('zrStatus');
  const setStatus = (msg, state='ok') => {
    const el = statusEl();
    if (el) el.textContent = msg;
    bar.setAttribute('data-state', state);
  };

  const debounce = (fn, ms=350) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  // Sheet id from URL (generate one if missing)
  const url = new URL(location.href);
  let sheetId = url.searchParams.get('sheet');
  if (!sheetId) {
    const rid = (crypto.randomUUID ? crypto.randomUUID() : (String(Math.random()).slice(2) + String(Date.now())));
    sheetId = rid.replace(/-/g,'').slice(0, 16);
    url.searchParams.set('sheet', sheetId);
    history.replaceState({}, '', url.toString());
  }

  // We persist: inputs, textareas, selects, and any contenteditable elements.
  const isEditable = (el) => el.isContentEditable || el.getAttribute('contenteditable') === '' || el.getAttribute('contenteditable') === 'true';

  const allFields = () => Array.from(document.querySelectorAll('input, textarea, select, [contenteditable], [contenteditable=""], [contenteditable="true"]'))
    .filter(el => !el.closest('#zr-sharebar'));

  // Ensure every field has a stable id so it can be saved/restored.
  const ensureStableIds = () => {
    let n = 0;
    allFields().forEach(el => {
      if (el.tagName === 'INPUT') {
        const t = (el.type || '').toLowerCase();
        if (['button','submit','reset','file','image'].includes(t)) return;
      }
      if (!el.id && !el.name) {
        el.id = `zr_auto_${n++}`;
      }
    });
  };

  const keyOf = (el) => el.name ? `n:${el.name}` : `i:${el.id}`;

  const readData = () => {
    ensureStableIds();
    const data = {};
    allFields().forEach(el => {
      // Skip non-data controls
      if (el.tagName === 'INPUT') {
        const t = (el.type || '').toLowerCase();
        if (['button','submit','reset','file','image'].includes(t)) return;
      }

      const key = keyOf(el);

      if (el.tagName === 'INPUT' && (el.type === 'checkbox' || el.type === 'radio')) {
        data[key] = !!el.checked;
      } else if (isEditable(el) && el.tagName !== 'INPUT') {
        data[key] = el.innerHTML;
      } else {
        data[key] = el.value;
      }
    });
    return data;
  };

  const applyData = (data) => {
    ensureStableIds();
    allFields().forEach(el => {
      if (el.tagName === 'INPUT') {
        const t = (el.type || '').toLowerCase();
        if (['button','submit','reset','file','image'].includes(t)) return;
      }

      const key = keyOf(el);
      if (!(key in data)) return;

      if (el.tagName === 'INPUT' && (el.type === 'checkbox' || el.type === 'radio')) {
        el.checked = !!data[key];
        el.dispatchEvent(new Event('change', { bubbles: true }));
      } else if (isEditable(el) && el.tagName !== 'INPUT') {
        el.innerHTML = data[key] ?? '';
        el.dispatchEvent(new Event('input', { bubbles: true }));
      } else {
        el.value = data[key] ?? '';
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  };

  const load = async () => {
    try {
      setStatus('Loading…', 'busy');
      const res = await fetch(`${API_BASE}/sheets/${encodeURIComponent(sheetId)}`);
      if (res.status === 404) {
        setStatus('New sheet (edit to autosave)', 'ok');
        return;
      }
      if (!res.ok) throw new Error(`Load failed: ${res.status}`);
      const payload = await res.json();
      if (payload?.data) applyData(payload.data);
      setStatus('Loaded ✓', 'ok');
    } catch (e) {
      console.warn(e);
      setStatus('Load error', 'err');
    }
  };

  const save = async () => {
    try {
      setStatus('Saving…', 'busy');
      const payload = { data: readData() };
      const res = await fetch(`${API_BASE}/sheets/${encodeURIComponent(sheetId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error(`Save failed: ${res.status}`);
      setStatus('Saved ✓', 'ok');
    } catch (e) {
      console.warn(e);
      setStatus('Save error', 'err');
    }
  };

  const scheduleSave = debounce(save, 400);

  // Save on edits (inputs + contenteditable)
  document.addEventListener('input', (e) => {
    if (!e.target) return;
    if (e.target.closest && e.target.closest('#zr-sharebar')) return;
    if (e.target.matches('input, textarea, select') || isEditable(e.target)) scheduleSave();
  }, true);

  document.addEventListener('change', (e) => {
    if (!e.target) return;
    if (e.target.closest && e.target.closest('#zr-sharebar')) return;
    if (e.target.matches('input, textarea, select')) scheduleSave();
  }, true);

  // Best-effort save on exit (keepalive avoids needing POST/sendBeacon)
  window.addEventListener('beforeunload', () => {
    try {
      const payload = { data: readData() };
      fetch(`${API_BASE}/sheets/${encodeURIComponent(sheetId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true,
      });
    } catch {}
  });

  // Buttons
  document.addEventListener('click', async (e) => {
    const id = e.target?.id;
    if (id === 'zrCopy') {
      try {
        await navigator.clipboard.writeText(location.href);
        setStatus('Link copied ✓', 'ok');
      } catch {
        prompt('Copy this link:', location.href);
      }
    }
    if (id === 'zrSave') save();
  });

  // Run
  ensureStableIds();
  load();
})();
</script>

</body>
</html>
